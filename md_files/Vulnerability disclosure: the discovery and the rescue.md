[ Curve Finance ](https://blog.curve.fi)

  * [Home](https://blog.curve.fi/)
  * [Trade on Curve](https://curve.fi/)

[ ](https://twitter.com/CurveFinance "Twitter")

Subscribe

# Vulnerability disclosure: the discovery and the rescue

  * [ ](/author/michael/)

#### [Michael Egorov](/author/michael/)

Jan 25, 2020 • 3 min read

At 3 a.m. I woke up to 20 messages from [Robert
Leshner](https://twitter.com/rleshner) and [Sam
Sun](https://twitter.com/samczsun). The news was that the [Curve contract
](https://github.com/curvefi/curve-contract/tree/compounded)had a critical
(but not exploited) vulnerability which allowed anyone to drain the smart
contract.

The bug wasn’t anything a linter could catch: it was hidden deep into Curve’s
algorithm. According to yet-to-be-shipped whitepaper, the solution of the
_master equation_ , which describes the link between the balances and the
invariant, is given by the following method:

![](https://lh4.googleusercontent.com/6XN80TNwdFRJ6tPRNSoEN_gmXYokk6T-1t-fU1NkIzLygWSXBmUzQpDB3tQ_7sTs4zy2TkAN0QZCnr-
OFW6HSAOied_aHRAR8C3hzjgaGH0nFbEt8yXm941j-LcKGU8M_SfHhZOz)

This method has, well, a product of all balances for _i_ not equal to _j_.
While _x_i_ is the “incoming” balance and _x_j_ is the “outgoing” balance, the
product if everything not including outgoing balance (used for the constant
_c_ ) is calculated by multiplying _x_i_ by everything else (except _j_ -th
component). Which is fine when we exchange _i_ -th asset into _j_ -th asset.
But what if _i_ == _j_? And here comes a problem.

![](https://lh3.googleusercontent.com/PSvOoWQyFnLStVsw-RZ-
ttKN_8Ph3LnKTyOmGiwJr1nC19r99D390JWClXZWiltdUMtwrJf3T1fUewnXqvo3U5Fa4q7ezBHCL-3UfJM_8aJ9dJRDPnyC-h2d1jGpLC1QnlT7GrSs)

The situation when _i == j_ is not accounted for, and submitting an exchange
of some asset into the same asset, essentially, drains this asset. _Anyone_
could do it.

So, what sort of action should be done in such a case?

One way could be to announce that there is a vulnerability and let people
quickly withdraw funds. However, that could bring too much attention of black
hat hackers who could find this vulnerability after knowing it exists.

Another way could be to attack the contract as a white hat, drain it and bring
funds back to liquidity providers. The problem is though that there are front-
running bots who look for transactions which turn with profit (not only for
hacks, but for arbitrage, too), and execute a competing transaction
automatically. And really, there was no good way around them.

The contract didn’t have any kill switch or upgrade capability (which could
give the company too much power to be considered not having a custody over
funds) except for asking all LPs to withdraw and/or migrate funds over.

Reaching all LPs privately was impossible, too, because of the overwhelming
success of Curve growing up to 100% a day.

In this situation, it was decided to deploy a new version (which was brewing
anyway) with newer and better parameters and other good changes, such as more
advanced logging, and the fix in question, however without disclosing the fix
in question publicly on github. Or, at least, before LPs migrate the funds. As
most trades were going from [1inch.exchange](https://1inch.exchange/), they
were able to switch to the new contract within 10 minutes, leaving the old,
vulnerable, contract without profits beyond Compound interest.

Immediately after deploying the new contract and UI, more than 50% of funds
were migrated over even before the official announcement. The rest of the
migration took 3 days.

In conclusion, the contract was fixed. There was a kill switch which stops
everything except withdrawals (however works only for the first two months
after the deployment) which was added. The audit of the (fixed) contract is
going to happen at the end of January. ETH Zurich have provided early access
to their [fantastic tool to do formal verification for Vyper
contracts](https://ethz.ch/content/dam/ethz/special-interest/infk/chair-
program-method/pm/documents/Education/Theses/Robin_Sierra_MA_Report.pdf) which
would’ve prevented this situation completely.

Although the situation was well handled, be careful with unaudited contracts
and only deposit what you can afford to lose before audits happen.

Curve wants to thank [Sam Sun](https://twitter.com/samczsun) who discovered
the vulnerability and helped handle the situation - a bug bounty was awarded,
[Robert Leshner](https://twitter.com/rleshner) (Compound), [Lev
Livnev](https://keybase.io/livnev), [Julien
Bouteloup](https://twitter.com/bneiluj) (Stake Capital), and [Richard
Burton](https://twitter.com/ricburton).

The DeFi field is new. Bonding curves are new. Smart contracts are recent. We
are in the unknown territory which hasn’t ever been explored. The journey to
rebuild the World Financial System can be dangerous at times. And exciting.  

## Sign up for more like this.

Enter your email Subscribe

[

## Discovery of a very unprobable Ledger JS signing issue

A Curve user wanted to swap 5 Bitcoin for wBTC. As Curve now supports native
Bitcoin deposit routed through the renVM, the user deposit the Bitcoin and
after six confirmations, Metamask prompted the user to confirm a transaction
to mint renBTC and swap it to wBTC (via the Curve sbtc

](/ledger-js-signing-issue/)

  * [ ](/author/angel/)

[Angel Angelov](/author/angel/) Jul 5, 2020 • 1 min read

[

## How Curve hacked Curve

In March, a sUSD incentivized pool was launched with Synthetix. The trial was
overwhelmingly successful as, while having smaller value in the pool, the pool
was providing a much deeper liquidity than sETH/ETH Uniswap pool. However, on
April 20th (was it only a week ago?), we (Angel and I)

](/how-curve-hacked-curve/)

  * [ ](/author/michael/)

[Michael Egorov](/author/michael/) Apr 28, 2020 • 2 min read

[

## Building liquid staking with Curve

As proof of stake on Ethereum becomes closer, new PoS blockchains (Cosmos,
Tezos and others) have been launched, there are and will be stakeable
ERC20-compatible tokens (NuCypher, Livepeer, Ren Project, Skale, KEEP, The
Graph), staking-as-a-service looks more and more as a lucrative business.
However, centralized exchanges (such as Binance) quickly

](/building-liquid-staking-with-curve/)

  * [ ](/author/michael/)

[Michael Egorov](/author/michael/) Feb 24, 2020 • 2 min read

[Curve Finance](https://blog.curve.fi) (C) 2022

[Powered by Ghost](https://ghost.org/)

